---
- name: Collect Hardware Information
  hosts: all
  gather_facts: yes
  tasks:
    - name: Gather CPU Model
      set_fact:
        # Standard x86 linux puts model name in index 2. Fallbacks provided.
        cpu_model: "{{ ansible_processor[2] | default(ansible_processor[0]) | default('Unknown') }}"

    - name: Prepare Host Info
      set_fact:
        proxmox_hw_info:
          manufacturer: "{{ ansible_system_vendor | default('Unknown') }}"
          productName: "{{ ansible_product_name | default('Unknown') }}"
          cpuModel: "{{ cpu_model }}"

- name: Generate JSON Inventory
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Aggregate Inventory Data
      set_fact:
        # Loop through all groups in inventory (excluding 'all' and 'ungrouped')
        # to treat them as Cluster Names
        full_inventory: >-
          {%- set result = {} -%}
          {%- for group_name in groups -%}
            {%- if group_name not in ['all', 'ungrouped'] -%}
              {%- set cluster_nodes = {} -%}
              {%- for host in groups[group_name] -%}
                {%- set host_info = hostvars[host]['proxmox_hw_info'] | default(None) -%}
                {%- if host_info -%}
                  {%- set _ = cluster_nodes.update({hostvars[host]['ansible_hostname']: host_info}) -%}
                {%- endif -%}
              {%- endfor -%}
              {%- if cluster_nodes -%}
                {# Format: proxmox_site1 -> PROXMOX SITE1 #}
                {%- set formatted_name = group_name | replace('_', ' ') | upper -%}
                {%- set _ = result.update({formatted_name: cluster_nodes}) -%}
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          {{ result }}

    - name: Write hardware_inventory.json
      copy:
        content: "{{ full_inventory | to_nice_json(indent=2) }}"
        dest: "../hardware_inventory.json"
      delegate_to: localhost

    - name: Display Result
      debug:
        msg: "Inventory generated at ../hardware_inventory.json"
